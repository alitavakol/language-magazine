<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">

		<!-- Material Design fonts -->
		<link rel="stylesheet" type="text/css" href="file:///android_asset/ubuntu.css">
		<link rel="stylesheet" type="text/css" href="../../../../src/main/assets/ubuntu.css">

		<!-- Bootstrap -->
		<link rel="stylesheet" type="text/css" href="file:///android_asset/bootstrap.min.css">
		<link rel="stylesheet" type="text/css" href="../../../../src/main/assets/bootstrap.min.css">

		<link rel="stylesheet" type="text/css" href="../styles.css">

		<style id="dynamic-rules">
		</style>

		<style type="text/css">
			body {
				overflow-y: scroll;
			}
			.grid {
				margin: 0 auto;
			}
			.grid-item {
				width: 200px;
				height: 150px;
				background-repeat: no-repeat;
				background-position: center;
				background-size: cover;
				border: solid 3px;
				-webkit-box-shadow: 0 1px 6px 0 rgba(0,0,0,.12),0 1px 6px 0 rgba(0,0,0,.12);
				box-shadow: 0 1px 6px 0 rgba(0,0,0,.12),0 1px 6px 0 rgba(0,0,0,.12);
				margin-bottom: 20px;
			}
			.grid-item--width2 {
				width: 420px;
			}
			.grid-item--height2 {
				height: 320px;
			}
			.grid-item--height4 {
				height: 640px;
			}
			h1, h3 {
				margin-top: 0;
			}
			h4 {
				font-weight: 400;
				margin-top: 20px;
			}
			.label-base {
				position: absolute;
				left: 0;
				right: 0;
				bottom: 0;
				text-align: center;
			}
			.label-container {
				display: inline-block;
				padding: 8px;
				margin-left: 8px;
				margin-right: 8px;
				margin-top: 6px;
				margin-bottom: 6px;
				-webkit-box-shadow: 0 1px 1.5px 0 rgba(0, 0, 0, 0.12), 0 1px 1px 0 rgba(0, 0, 0, 0.24);
				box-shadow: 0 2px 3px 0 rgba(0, 0, 0, 0.12), 0 1px 1px 0 rgba(0, 0, 0, 0.24);
			}
			.label-container.gone {
				opacity: .2;
				-webkit-box-shadow: inherit;
				box-shadow: inherit;
			}
			.label-base .label-container {
				display: none;
			}
			#labels {
				margin-left: -8px;
				padding-bottom: 16px;
				text-align: center;
			}
			.lockable {
				background-size: cover;
				background-repeat: no-repeat;
				background-position: center;
			}
		</style>

		<style id="local-rules">
		</style>

		<script src="file:///android_asset/jquery-1.11.3.min.js"></script>
		<script src="../../../../src/main/assets/jquery-1.11.3.min.js"></script>
		<script src="file:///android_asset/tinycolor-min.js"></script>
		<script src="../../../../src/main/assets/tinycolor-min.js"></script>
		<script src="masonry.pkgd.min.js"></script>
		<script src="jquery-ui.min.js"></script>
		<script src="jquery.ui.touch-punch.min.js"></script>
		<script src="file:///android_asset/jquery.mobile.custom.min.js"></script>
		<script src="../../../../src/main/assets/jquery.mobile.custom.min.js"></script>

		<script src="../code.js"></script>
		<script src="../debug.js"></script>

		<!--Let browser know website is optimized for mobile-->
		<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
	</head>

	<body>
		<div class="foundation">
			<div id="top-margin"></div>

			<h1>Train Anger</h1>
			<h3>A doctor gets angry on a train.</h3>

			<h4><span class="accent">❶</span> <b>Excercise</b></h4>
			<p>See if you can do this matching exercise. Look at the list of things, and the photos. Match the name of each thing in the list below.</p>

			<div id="labels"></div>

			<div class="grid">
				<div class="grid-item" style="background-image: url('G.jpg');" data-label='G'></div>
				<div class="grid-item" style="background-image: url('F.jpg');" data-label='F'></div>
				<div class="grid-item grid-item--height2 grid-item--width2" style="background-image: url('A.jpg');" data-label='A'></div>
				<div class="grid-item grid-item--width2" style="background-image: url('C.jpg');" data-label='C'></div>
				<div class="grid-item" style="background-image: url('H.jpg');" data-label='H'></div>
				<div class="grid-item grid-item--width4" style="background-image: url('D.jpg');" data-label='D'></div>
				<div class="grid-item grid-item--width4" style="background-image: url('B.jpg');" data-label='B'></div>
				<div class="grid-item grid-item--height2 grid-item--width2" style="background-image: url('E.jpg');" data-label='E'></div>
			</div>

			<h4><span class="accent">❷</span> <b>Listening</b></h4>
			<div class="lockable"><div id="transcript" style="background-size: contain; background-repeat: no-repeat; background-position: center;">
					<p><span data-start="14428" data-end="23390">A doctor was on a train. He ordered some food. But when the food came, he got very angry. Why?</span></p>
					<p><span data-start="23391" data-end="28805">Dr. Russell Walshaw was on a train. He was travelling to London.</span> <span data-start="28806" data-end="33810">At the time of the incident, he was in the first class <a class="new-word" data-word="a dining carriage" data-type="n" data-en="a special car/carriage in a train where people eat and there is a restaurant" data-fa="واگن اختصاصی به عنوان رستوران">dining carriage</a>.</span> <span data-start="33811" data-end="39440">The 66-year-old doctor was sitting there when a <a class="new-word" data-word="a steward" data-type="n" data-en="a person who works on a train/airplane serving food, helping passengers, etc" data-fa="خدمت‌کار قطار یا هواپیما">steward</a> came to talk to him.</span> <span data-start="39441" data-end="42619">The steward wanted to prepare the tables for lunch.</span> <span data-start="42620" data-end="47320">So, he asked the doctor <a class="new-word" data-word="politely" data-type="adv" data-en="with respect; considerately; not rudely" data-fa="محترمانه">politely</a>, “Would you mind moving, please?”</span> <span data-start="47321" data-end="54988">However, the doctor didn’t want to move. He had just finished eating breakfast and he was working on his <a class="new-word" data-word="a laptop" data-type="n" data-en="a small, portable computer that opens and closes like a book" data-fa="لپ‌تاپ">laptop</a>.</span> <span data-start="54989" data-end="58988">“You can <a class="new-word" data-word="to lay the table" data-type="exp" data-en="to prepare a table for eating: to put plates, glasses, forks, knives, etc on it" data-fa="چیدن و آماده کردن میز غذاخوری">lay the table</a> around me,” the doctor said.</span></p>
					<p><span data-start="58989" data-end="63590">The doctor continued working until the steward came back to lay the table.</span> <span data-start="63591" data-end="66210">But then the problems started.</span> <span data-start="66211" data-end="72540">“The steward put the <a class="new-word" data-word="a plate" data-type="n" data-en="a round, flat ceramic object on which you put food to eat" data-fa="بشقاب">plate</a> down on the table very <a class="new-word" data-word="forcefully" data-type="adv" data-en="with a lot of force" data-fa="با فشار">forcefully</a>,” the doctor explained.</span> <span data-start="72541" data-end="79643">“I shouted at the steward. But he just walked away. I was so angry that I threw a plate.”</span></p>
					<p><span data-start="79644" data-end="86020">The doctor was given a <a class="new-word" data-word="a warning" data-type="n" data-en="if you give someone a “warning”, you tell them of a possible danger in the future" data-fa="هشدار نسبت به خطر پیش رو">warning</a> from the General Medical Council in London (The GMC).</span> <span data-start="86021" data-end="90049">They said that the doctor’s actions were “unacceptable”.</span> <span data-start="90050" data-end="95733">In his defence, the doctor said that he had been responding to the steward’s aggression.</span> <span data-start="95734" data-end="102400">“The steward <a class="new-word" data-word="to drop" data-type="vb" data-en="to let something fall from your hands; if something “drops”, it falls accidentally" data-fa="ناگهان انداختن">dropped</a> the plate on my table and showed <a class="new-word" data-word="bad manners" data-type="exp" data-en="if you have “bad manners”, you are not polite to someone; you say/do rude things" data-fa="اخلاق بد و نا ملایم">bad manners</a>,” the doctor explained.</span> <span data-start="102401" data-end="114800">“Also, I didn’t throw the plate at him, I threw the plate in his general direction. I’m sorry that it hit him. Perhaps I should have just shouted at him instead.”</span> <span class="accent">✪</span></p>
			</div></div>

			<div id="bottom-margin"></div>
		</div>

		<script type="text/javascript">
			restoringInstanceState = false;

			var label_template = "<div class='label-container draggable' data-image='{img}.jpg' data-label='{img}'>{label}</div>";
			var attached_label_template = "<div class='label-base'><div class='label-container'>{label}</div></div>";

			container = $('#labels');
			[['Car', 'H'], ['Helicopter', 'C'], ['Train', 'D'], ['Bus', 'B'], ['Ship', 'E'], ['Bicycle', 'G'], ['Motorbike', 'F'], ['Balloon', 'A']].forEach(function(label) {
					container.append(label_template.replace(/\{label\}/g, label[0]).replace(/\{img\}/g, label[1]));
					$(".grid-item[data-label='" + label[1] + "']").append(attached_label_template.replace(/\{label\}/g, label[0]));
			});

			dropped_elements = [];

			$('.draggable').draggable({
				revert: 'invalid',
				containment: 'body',
				zIndex: 2,
				appendTo: 'body',
				helper: 'clone',
				scrollSensitivity: 40,
				scrollSpeed: 10,
				start: function(e,u) {
					$('.label-container').removeClass('selected');
					$(e.target).addClass('gone');
				},
				stop: function(e,u) {
					if(!$(e.target).data('gone'))
						$(e.target).removeClass('gone').trigger('tap');
				},
			});
			$('.draggable').tap(function() {
				if(!$(this).hasClass('gone')) {
					$('.label-container').removeClass('selected');
					$(this).addClass('selected');
				}
			});

			$('.grid-item').droppable({
				activate: function(ev, ui) {
				},
				deactivate: function(ev, ui) {
				},
				drop: function(event, ui) {
					drop(ui.draggable, $(this));
				}
			});
			$('.grid-item').tap(function() {
				drop($('.draggable.selected'), $(this));
			});

			drop = function(dropped, dropzone) {
				if(!dropped.length || !dropzone.length)
					return;

				var label = dropzone.data('label');
				if(label == dropped.data('label')) {
					dropzone.find('.label-container').css('display', 'inline-block');
					dropped.draggable('disable');
					dropped.data('gone', true).removeClass('selected').addClass('gone');

					if(dropped_elements.indexOf(label) == -1) {
						dropped_elements.push(label);
						saveInstanceState();
					}

				} else {
					dropped.removeClass('gone');
					$('.label-container').removeClass('selected');
					if(typeof(app) != 'undefined')
						app.makeToast('That\'s not right.', false);
				}
			}

			adjustCustomLayout = function(options) {
				var columnWidth = $('.foundation').width() - 2*horizontalMargin - spacing;
				if(columnWidth > 800) {
					columnWidth /= 5;
				}
				else if(columnWidth > 640)
					columnWidth /= 4;
				else if(columnWidth > 320)
					columnWidth /= 3;
				else
					columnWidth /= 2;
				columnWidth -= spacing;
				columnHeight = 3 * columnWidth / 4;

				$('#local-rules').text("\
					#top-margin { height: " + (topMargin+verticalMargin) + "px; } \
					#bottom-margin { height: " + bottomMargin + "px; } \
					body { background: -webkit-linear-gradient(#" + accentColor + ",#" + backgroundColor + "); background-repeat: no-repeat; -webkit-background-attachment: fixed; } \
					.foundation { margin-left: " + horizontalMargin + "px; padding-left: " + horizontalMargin + "px; padding-right: " + horizontalMargin + "px; background-color: #" + backgroundColor + "; } \
					.grid { margin-right: -" + spacing + "px; } \
					.grid-item { margin-bottom: " + spacing + "px; } \
					.grid-item { width: " + columnWidth + "px; height: " + columnHeight + "px; } \
					.grid-item--height2 { height: " + (2*columnHeight+spacing) + "px; } \
					.grid-item--height4 { height: " + (4*columnHeight+3*spacing) + "px; } \
					.grid-item--width2 { width: " + (2*columnWidth+spacing) + "px; } \
					.label-container { background-color: " + highlightColor + "; } \
					.label-container.selected { background-color: #" + accentColor + "; } \
					h1 { color: " + tinycolor(accentColor).darken() + "; font-weight: bold; } \
				");

				$('.grid').masonry({
					itemSelector: '.grid-item',
					columnWidth: columnWidth,
					gutter: spacing,
				});
			}

			prevScroll = 0;

			lock = function(b) {
				transcriptLocked = b;

				if(b) {
					$('#transcript').css('background-image', 'url("key-enter-access-door-place-512.png")').children().css('visibility', 'hidden');
					$('.lockable').css({'background-image': "url('angry-doctor.jpg')", border: 'solid 1px black'});

				} else {
					$('#transcript').css('background-image', '').children().css('visibility', '');
					$('.lockable').css({'background-image': '', border: 'solid 1px white'});
				}

				saveInstanceState();
			}

			saveInstanceState = function() {
				if(restoringInstanceState)
					return;

				outState = {
					dropped_elements: dropped_elements,
					scroll: prevScroll,
					transcriptLocked: transcriptLocked,
				};

				if(typeof(app) != 'undefined')
					app.saveInstanceState(JSON.stringify(outState));
			}

			restoreInstanceState = function(savedInstanceState) {
				restoringInstanceState = true;
				state = JSON.parse(savedInstanceState);

				dropped_elements = state['dropped_elements'] || [];
				dropped_elements.forEach(function(label) {
					drop($(".label-container[data-label='" + label + "']"), $(".grid-item[data-label='" + label + "']"));
				});

				$('body').scrollTop((state['scroll'] || 0) * $('body').height());
				prevScroll = $('body').scrollTop() / $('body').height();

				lock(state.transcriptLocked || true);

				restoringInstanceState = false;
			}

			taphold = false;
			$('.lockable').tap(function() {
				if(transcriptLocked && !taphold)
					app.makeToast('Tap and hold to reveal transcript.', false);
				taphold = false;
			});
			$('.lockable').taphold(function() {
				taphold = true;
				if(transcriptLocked)
					app.lockTranscript(!transcriptLocked);
			});

			if(typeof(app) != 'undefined')
				app.showLockControls(true);

			setInterval(function() {
				scroll = $('body').scrollTop() / $('body').height();
				if(scroll != prevScroll) {
					prevScroll = scroll;
					saveInstanceState();
				}
			}, 3000);
		</script>
	</body>
</html>
